<!--
  Página de Criação/Edição de Eventos
  Design multi-step responsivo com tema roxo
-->
<div class="page-container">
  <div class="form-card">
    <!-- Cabeçalho com o título da página e navegação -->
    <div class="card-header">
      <h1 class="header-title">{{ getPageTitle() }}</h1>
      <a class="header-link" routerLink="/home">Voltar para Home</a>
    </div>

    <!-- Indicador de Progresso (Stepper) -->
    <div class="stepper">
      <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
        <div class="step-icon">
          <span *ngIf="currentStep <= 1">1</span>
          <span *ngIf="currentStep > 1" class="check-icon"><i class="bi bi-check"></i></span>
        </div>
        <div class="step-label">Informações Básicas</div>
      </div>
      <div class="step-connector"></div>
      <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
        <div class="step-icon">
          <span *ngIf="currentStep <= 2">2</span>
          <span *ngIf="currentStep > 2" class="check-icon"><i class="bi bi-check"></i></span>
        </div>
        <div class="step-label">Localização</div>
      </div>
      <div class="step-connector"></div>
      <div class="step" [class.active]="currentStep === 3">
        <div class="step-icon">3</div>
        <div class="step-label">Detalhes</div>
      </div>
    </div>

    <!-- Formulário Principal -->
    <form [formGroup]="eventForm" (ngSubmit)="onSubmit()">
      
      <!-- Passo 1: Informações Básicas -->
      <div class="form-step-content" *ngIf="currentStep === 1">
        <h2 class="step-title">Informações Básicas</h2>
        <p class="step-subtitle">Comece com o essencial para o seu evento.</p>

        <div class="form-grid">
          <!-- Nome do Evento -->
          <div class="form-group span-2">
            <label for="eventName">Nome do Evento *</label>
            <input 
              id="eventName" 
              formControlName="eventName" 
              placeholder="Ex: Festa de Halloween Guadalupe"
              [class.error]="hasError('eventName')"
            >
            <span class="error-message" *ngIf="hasError('eventName')">{{ getError('eventName') }}</span>
          </div>

          <!-- Data (only shown for non-recurring events) -->
          <div class="form-group" *ngIf="!eventForm.get('isRecurring')?.value">
            <label for="eventDate">Data do Evento *</label>
            <input 
              id="eventDate" 
              type="date" 
              formControlName="eventDate"
              [class.error]="hasError('eventDate')"
            >
            <span class="error-message" *ngIf="hasError('eventDate')">{{ getError('eventDate') }}</span>
          </div>

          <!-- Hora -->
          <div class="form-group">
            <label for="eventTime">Hora do Evento *</label>
            <input 
              id="eventTime" 
              type="time" 
              formControlName="eventTime"
              [class.error]="hasError('eventTime')"
            >
            <span class="error-message" *ngIf="hasError('eventTime')">{{ getError('eventTime') }}</span>
          </div>

          <!-- Recurring Event Toggle -->
          <div class="form-group span-2">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                formControlName="isRecurring"
              >
              <span class="checkbox-text">Este é um evento recorrente</span>
            </label>
          </div>

          <!-- Recurring Options (shown when isRecurring is true) -->
          <div class="form-group span-2" *ngIf="eventForm.get('isRecurring')?.value">
            <label for="recurrenceType">Tipo de Recorrência *</label>
            <select 
              id="recurrenceType" 
              formControlName="recurrenceType"
              [class.error]="hasError('recurrenceType')"
            >
              <option value="">Selecione o tipo de recorrência</option>
              <option value="weekly">Semanal</option>
              <option value="monthly">Mensal</option>
            </select>
            <span class="error-message" *ngIf="hasError('recurrenceType')">{{ getError('recurrenceType') }}</span>
          </div>

          <!-- Weekly Recurrence Options -->
          <div class="form-group span-2" *ngIf="eventForm.get('isRecurring')?.value && eventForm.get('recurrenceType')?.value === 'weekly'">
            <label>Dias da Semana *</label>
            <div class="weekly-days">
              <label class="day-checkbox" 
                     *ngFor="let day of weekDays"
                     [class.selected]="isDaySelected(day.value)">
                <input 
                  type="checkbox" 
                  [value]="day.value" 
                  [checked]="isDaySelected(day.value)"
                  (change)="onWeekDayChange(day.value, $event)"
                >
                <span class="checkbox-text">{{ day.label }}</span>
              </label>
            </div>
            <span class="error-message" *ngIf="hasError('weeklyDays') && eventForm.get('recurrenceType')?.value === 'weekly'">
              Selecione pelo menos um dia da semana
            </span>
          </div>

          <!-- Monthly Recurrence Options -->
          <div class="form-group span-2" *ngIf="eventForm.get('isRecurring')?.value && eventForm.get('recurrenceType')?.value === 'monthly'">
            <label for="monthlyDays">Dias do Mês (separados por vírgula) *</label>
            <input 
              id="monthlyDays" 
              type="text" 
              formControlName="monthlyDays"
              placeholder="Ex: 1, 15, 30"
              [class.error]="hasError('monthlyDays')"
            >
            <span class="error-message" *ngIf="hasError('monthlyDays')">{{ getError('monthlyDays') }}</span>
            <small class="field-hint">Insira os dias do mês separados por vírgula (1-31)</small>
          </div>
        </div>
      </div>

      <!-- Passo 2: Localização com Mapa -->
      <div class="form-step-content" *ngIf="currentStep === 2">
        <h2 class="step-title">Localização do Evento</h2>
        <p class="step-subtitle">Informe o endereço e selecione a localização exata no mapa.</p>
        
        <div class="form-grid">
          <!-- Endereço -->
          <div class="form-group span-2" formGroupName="location">
            <label for="map-address">Endereço Completo *</label>
            <div class="address-input-wrapper">
              <input 
                id="map-address"
                formControlName="address" 
                placeholder="Ex: Rua das Palmeiras, 123, Salvador, BA"
                [class.error]="hasError('location.address')"
                required>
              <button 
                type="button" 
                class="btn-verify-location"
                (click)="geocodeAddress()"
                [disabled]="isVerifyingLocation"
                title="Verificar Localização"
              >
                <i class="bi bi-geo-alt" *ngIf="!isVerifyingLocation"></i>
                <i class="bi bi-hourglass-split" *ngIf="isVerifyingLocation"></i>
                {{ isVerifyingLocation ? 'Buscando...' : 'Buscar' }}
              </button>
            </div>
            <div class="geocoding-results" *ngIf="geocodingResults.length > 0">
              <div class="result-item" 
                   *ngFor="let result of geocodingResults"
                   (click)="selectGeocodingResult(result)">
                {{ result.display_name }}
              </div>
            </div>
            <div class="error-message" *ngIf="geocodingError">
              {{ geocodingError }}
            </div>
            <span class="error-message" *ngIf="hasError('location.address')">{{ getError('location.address') }}</span>
          </div>

          <!-- Cidade -->
          <div class="form-group" formGroupName="location">
            <label for="map-city">Cidade *</label>
            <input 
              id="map-city" 
              formControlName="city" 
              placeholder="Ex: Salvador"
              [class.error]="hasError('location.city')"
            >
            <span class="error-message" *ngIf="hasError('location.city')">{{ getError('location.city') }}</span>
          </div>

          <!-- Estado -->
          <div class="form-group" formGroupName="location">
            <label for="map-state">Estado *</label>
            <input 
              id="map-state" 
              formControlName="state" 
              placeholder="Ex: BA"
              [class.error]="hasError('location.state')"
            >
            <span class="error-message" *ngIf="hasError('location.state')">{{ getError('location.state') }}</span>
          </div>

          <!-- Mapa -->
          <div class="form-group span-2">
            <label>Selecione no mapa *</label>
            <div id="event-map" class="map"></div>
            <small class="field-hint">Clique no mapa para selecionar a localização exata do evento.</small>
            <div class="coordinates-display" *ngIf="eventForm.get('coordinates')?.value">
              Coordenadas: {{ eventForm.get('coordinates')?.value.lat | number:'1.4-4' }}, {{ eventForm.get('coordinates')?.value.lng | number:'1.4-4' }}
            </div>
            <span class="error-message" *ngIf="!eventForm.get('coordinates')?.value && submitError">Por favor, selecione a localização no mapa.</span>
          </div>
        </div>
      </div>
      
      <!-- Passo 3: Detalhes -->
      <div class="form-step-content" *ngIf="currentStep === 3">
        <h2 class="step-title">Detalhes do Evento</h2>
        <p class="step-subtitle">Forneça mais informações para os participantes.</p>
        
        <div class="form-grid">
           <!-- Idade Mínima -->
           <div class="form-group">
            <label for="minAge">Idade Mínima *</label>
            <input 
              id="minAge" 
              type="number" 
              formControlName="minAge" 
              placeholder="18"
              min="0"
              max="99"
              [class.error]="hasError('minAge')"
            >
            <span class="error-message" *ngIf="hasError('minAge')">{{ getError('minAge') }}</span>
          </div>

          <!-- Máximo de Participantes -->
          <div class="form-group">
            <label for="maxParticipants">Nº de Participantes *</label>
            <input 
              id="maxParticipants" 
              type="number" 
              formControlName="maxParticipants" 
              placeholder="40"
              min="1"
              [class.error]="hasError('maxParticipants')"
            >
            <span class="error-message" *ngIf="hasError('maxParticipants')">{{ getError('maxParticipants') }}</span>
          </div>
          
          <!-- Link do WhatsApp -->
          <div class="form-group span-2">
            <label for="whatsappLink">Link para Grupo do WhatsApp (Opcional)</label>
            <input 
              id="whatsappLink" 
              formControlName="whatsappLink" 
              placeholder="https://wa.me/558512345678"
              [class.error]="hasError('whatsappLink')"
            >
            <span class="error-message" *ngIf="hasError('whatsappLink')">{{ getError('whatsappLink') }}</span>
            <small class="field-hint">Use o formato: https://wa.me/[número] ou https://chat.whatsapp.com/[código]</small>
          </div>

          <!-- Detalhes Adicionais -->
          <div class="form-group span-2">
            <label for="details">Informações Adicionais</label>
            <textarea 
              id="details" 
              formControlName="details" 
              rows="4" 
              placeholder="Ex: Traga sua bebida, teremos petiscos, música ao vivo..."
            ></textarea>
          </div>
          
          <!-- Opções de Privacidade -->
          <div class="form-group span-2">
            <label>Privacidade do Evento *</label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" value="aberta" formControlName="privacy">
                <span class="radio-icon"><i class="bi bi-globe-americas"></i></span>
                <div class="radio-content">
                  <span class="radio-title">Aberto</span>
                  <span class="radio-description">Qualquer um pode ver e participar</span>
                </div>
              </label>
              <label class="radio-label">
                <input type="radio" value="fechada" formControlName="privacy">
                <span class="radio-icon"><i class="bi bi-lock"></i></span>
                <div class="radio-content">
                  <span class="radio-title">Fechado</span>
                  <span class="radio-description">Requer aprovação para participar</span>
                </div>
              </label>
            </div>
          </div>
          
          <!-- URL da Imagem -->
          <div class="form-group span-2">
            <label for="imageUrl">URL da Imagem do Evento (Opcional)</label>
            <input 
              id="imageUrl" 
              formControlName="imageUrl" 
              placeholder="https://exemplo.com/imagem.jpg"
              (input)="onImageUrlChange()"
              [class.error]="hasError('imageUrl')"
            >
            <span class="error-message" *ngIf="hasError('imageUrl')">{{ getError('imageUrl') }}</span>
            <small class="field-hint">Cole o link de uma imagem hospedada online (JPG, PNG, GIF, WebP)</small>
            
            <!-- Preview da Imagem -->
            <div class="image-preview-container" *ngIf="imagePreview">
              <div class="image-preview">
                <img [src]="imagePreview" alt="Preview do evento" (error)="imagePreview = null">
                <button type="button" class="remove-image" (click)="eventForm.get('imageUrl')?.setValue(''); imagePreview = null">✕</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Botões de Navegação do Formulário -->
      <div class="form-actions">
        <button 
          type="button" 
          class="btn btn-secondary" 
          *ngIf="currentStep > 1" 
          (click)="prevStep()"
          [disabled]="isLoading"
        >
          <i class="bi bi-arrow-left"></i> Anterior
        </button>
        
        <div class="spacer"></div>
        
        <button 
          type="button" 
          class="btn btn-primary" 
          *ngIf="currentStep < 3" 
          (click)="nextStep()"
          [disabled]="isLoading || (currentStep === 1 && eventForm.get('eventName')?.invalid)"
        >
          Próximo <i class="bi bi-arrow-right"></i>
        </button>
        
        <button 
          type="submit" 
          class="btn btn-primary btn-create" 
          *ngIf="currentStep === 3" 
          [disabled]="eventForm.invalid || isLoading"
        >
          <span *ngIf="!isLoading"><i class="bi bi-plus-lg"></i> {{ getSubmitButtonText() }}</span>
          <span *ngIf="isLoading"><i class="bi bi-hourglass-split"></i> Processando...</span>
        </button>
      </div>
    </form>
  </div>
</div>